name: Flip Orders In Shipped

on:
  workflow_dispatch:
  # Later:
  # schedule:
  #   - cron: "*/15 * * * *"

jobs:
  complete:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Restore shipped-order state cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: shipped-state-${{ github.run_id }}
          restore-keys: |
            shipped-state-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run completion logic
        id: run
        env:
          BC_STORE_ID: ${{ secrets.BC_STORE_ID }}
          BC_AUTH_TOKEN: ${{ secrets.BC_AUTH_TOKEN }}

          FEDEX_CLIENT_ID: ${{ secrets.FEDEX_CLIENT_ID }}
          FEDEX_CLIENT_SECRET: ${{ secrets.FEDEX_CLIENT_SECRET }}
          FEDEX_ENV: prod  # or sandbox

          STATE_PATH: .cache/shipped_state.json

          # Existing alert file (missing tracking)
          ALERT_PATH: .cache/missing_tracking.md

          # New alert files for the updated python script
          FEDEX_EMPTY_ALERT_PATH: .cache/fedex_empty.md
          INVALID_TRACKING_ALERT_PATH: .cache/invalid_tracking.md

          MIN_FEDEX_CHECK_INTERVAL_SEC: "600"   # 10 minutes
          MAX_ORDERS_PER_RUN: "0"               # 0 = no cap
          DRY_RUN: "false"
          LOG_LEVEL: INFO
        run: |
          python scripts/complete_shipped_orders.py

      - name: Create / update GitHub Issue if Ship By Weight missing tracking
        if: steps.run.outputs.missing_tracking == 'true'
        uses: actions/github-script@v7
        env:
          ALERT_PATH: .cache/missing_tracking.md
        with:
          script: |
            const fs = require('fs');
            const path = process.env.ALERT_PATH || '.cache/missing_tracking.md';
            const body = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : 'See workflow logs for details.';
            const title = 'ALERT: Ship By Weight orders missing tracking number';
            const labels = ['ops','shipping','alert'];

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `New occurrence detected in run ${context.runId}:\n\n${body}`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                labels
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `Detected in run ${context.runId}:\n\n${body}`,
                labels
              });
            }

      - name: Create / update GitHub Issue if FedEx returns empty/unusable results
        if: steps.run.outputs.fedex_empty == 'true'
        uses: actions/github-script@v7
        env:
          ALERT_PATH: .cache/fedex_empty.md
        with:
          script: |
            const fs = require('fs');
            const path = process.env.ALERT_PATH || '.cache/fedex_empty.md';
            const body = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : 'See workflow logs for details.';
            const title = 'ALERT: FedEx returned empty/unusable tracking results';
            const labels = ['ops','shipping','alert','fedex'];

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `New occurrence detected in run ${context.runId}:\n\n${body}`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                labels
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `Detected in run ${context.runId}:\n\n${body}`,
                labels
              });
            }

      - name: Create / update GitHub Issue if invalid FedEx tracking numbers are detected
        if: steps.run.outputs.invalid_tracking == 'true'
        uses: actions/github-script@v7
        env:
          ALERT_PATH: .cache/invalid_tracking.md
        with:
          script: |
            const fs = require('fs');
            const path = process.env.ALERT_PATH || '.cache/invalid_tracking.md';
            const body = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : 'See workflow logs for details.';
            const title = 'ALERT: Invalid FedEx tracking numbers detected';
            const labels = ['ops','shipping','alert','fedex'];

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `New occurrence detected in run ${context.runId}:\n\n${body}`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                labels
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `Detected in run ${context.runId}:\n\n${body}`,
                labels
              });
            }
