name: Complete Shipped Orders

on:
  workflow_dispatch:
  # Later, if you want it to run automatically:
  # schedule:
  #   - cron: "*/15 * * * *"

jobs:
  complete:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # Cache a small state file between runs so we don't have to re-fetch
      # shipping method / tracking # details from BigCommerce for the same shipped orders.
      - name: Restore shipped-order state cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: shipped-state-${{ github.run_id }}
          restore-keys: |
            shipped-state-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run completion logic
        env:
          # BigCommerce
          BC_STORE_ID: ${{ secrets.BC_STORE_ID }}
          BC_AUTH_TOKEN: ${{ secrets.BC_AUTH_TOKEN }}

          # FedEx Track API
          FEDEX_CLIENT_ID: ${{ secrets.FEDEX_CLIENT_ID }}
          FEDEX_CLIENT_SECRET: ${{ secrets.FEDEX_CLIENT_SECRET }}
          FEDEX_ENV: prod  # or sandbox

          # Script options
          STATE_PATH: .cache/shipped_state.json
          MIN_FEDEX_CHECK_INTERVAL_SEC: "600"   # 10 minutes
          MAX_ORDERS_PER_RUN: "0"               # 0 = no cap
          DRY_RUN: "false"
          LOG_LEVEL: INFO

        run: |
          python scripts/complete_shipped_orders.py

      # NOTE: actions/cache@v4 automatically saves the cache at the end of the job
      # if the primary key was not found (which is true here because we use run_id).
